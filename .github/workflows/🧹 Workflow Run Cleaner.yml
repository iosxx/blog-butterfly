name: ğŸ§¹ Cleanup Old Workflow Runs

# è§¦å‘æ¡ä»¶ï¼šæ¯å‘¨æ—¥è‡ªåŠ¨è¿è¡Œï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥0ç‚¹æ‰§è¡Œå‘¨åº¦æ¸…ç†
  workflow_dispatch:
    inputs:
      full_cleanup:
        description: 'æ˜¯å¦æ‰§è¡Œå…¨é‡æ¸…ç†ï¼ˆåˆ é™¤æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå¿½ç•¥ä¿ç•™å¤©æ•°ï¼‰'
        type: boolean
        required: false
        default: false

jobs:
  determine-mode:
    runs-on: ubuntu-latest
    outputs:
      mode: ${{ steps.set-mode.outputs.mode }}
    steps:
      - name: åˆ¤å®šæ¸…ç†æ¨¡å¼
        id: set-mode
        run: |
          if ${{ github.event.inputs.full_cleanup == 'true' }}; then
            echo "mode=full" >> $GITHUB_OUTPUT
            echo "::warning::ğŸš¨ å…¨é‡æ¸…ç†æ¨¡å¼æ¿€æ´»ï¼å°†åˆ é™¤æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å·¥ä½œæµå†å²"
          else
            echo "mode=weekly" >> $GITHUB_OUTPUT
            echo "::notice::â„¹ï¸ æ‰§è¡Œå‘¨åº¦æ¸…ç†ï¼ˆä¿ç•™7å¤©å†…è®°å½•ï¼‰"
          fi

  cleanup:
    needs: determine-mode
    runs-on: ubuntu-latest
    permissions:
      actions: write  # å¿…é¡»å…·å¤‡åˆ é™¤å·¥ä½œæµçš„æƒé™
    steps:
      - name: æ¸…ç†å·¥ä½œæµå†å²
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # ä¿ç•™å¤©æ•°ï¼šå‘¨åº¦æ¨¡å¼ä¿ç•™7å¤©ï¼Œå…¨é‡æ¨¡å¼ä¿ç•™0å¤©ï¼ˆä»…åˆ é™¤æ—§äº0å¤©çš„è®°å½•ï¼Œå³æ‰€æœ‰å¯åˆ è®°å½•ï¼‰
          retain_days: ${{ needs.determine-mode.outputs.mode == 'full' && 0 || 7 }}
          # è‡³å°‘ä¿ç•™çš„è¿è¡Œæ¬¡æ•°ï¼ˆé˜²æ­¢è¯¯åˆ æ‰€æœ‰è®°å½•ï¼‰
          keep_minimum_runs: 5
          # å¯é€‰ï¼šä»…åˆ é™¤åŒ¹é…åç§°æ¨¡å¼çš„å·¥ä½œæµï¼ˆå¦‚ 'Deploy*' åŒ¹é…æ‰€æœ‰éƒ¨ç½²ç›¸å…³å·¥ä½œæµï¼‰
          # delete_workflow_pattern: 'Deploy*'
          # å¯é€‰ï¼šæŒ‰çŠ¶æ€åˆ é™¤ï¼ˆå¦‚ 'completed' ä»…åˆ é™¤å·²å®Œæˆçš„ï¼‰
          # delete_workflow_by_state_pattern: 'completed'
          # å¯é€‰ï¼šæŒ‰ç»“è®ºåˆ é™¤ï¼ˆå¦‚ 'failure' ä»…åˆ é™¤å¤±è´¥çš„è¿è¡Œï¼‰
          # delete_run_by_conclusion_pattern: 'failure'
          # æµ‹è¯•æ¨¡å¼ï¼šè®¾ä¸ºtrueæ—¶ä»…æ˜¾ç¤ºè¦åˆ é™¤çš„è®°å½•ï¼Œä¸å®é™…åˆ é™¤
          dry_run: false
