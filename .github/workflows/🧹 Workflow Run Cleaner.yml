name: 🧹 Cleanup Old Workflow Runs

# 触发条件：每周日自动运行，或手动触发
on:
  schedule:
    - cron: '0 0 * * 0'  # 每周日0点执行周度清理
  workflow_dispatch:
    inputs:
      full_cleanup:
        description: '是否执行全量清理（删除所有符合条件的记录，忽略保留天数）'
        type: boolean
        required: false
        default: false

jobs:
  determine-mode:
    runs-on: ubuntu-latest
    outputs:
      mode: ${{ steps.set-mode.outputs.mode }}
    steps:
      - name: 判定清理模式
        id: set-mode
        run: |
          if ${{ github.event.inputs.full_cleanup == 'true' }}; then
            echo "mode=full" >> $GITHUB_OUTPUT
            echo "::warning::🚨 全量清理模式激活！将删除所有符合条件的工作流历史"
          else
            echo "mode=weekly" >> $GITHUB_OUTPUT
            echo "::notice::ℹ️ 执行周度清理（保留7天内记录）"
          fi

  cleanup:
    needs: determine-mode
    runs-on: ubuntu-latest
    permissions:
      actions: write  # 必须具备删除工作流的权限
    steps:
      - name: 清理工作流历史
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # 保留天数：周度模式保留7天，全量模式保留0天（仅删除旧于0天的记录，即所有可删记录）
          retain_days: ${{ needs.determine-mode.outputs.mode == 'full' && 0 || 7 }}
          # 至少保留的运行次数（防止误删所有记录）
          keep_minimum_runs: 5
          # 可选：仅删除匹配名称模式的工作流（如 'Deploy*' 匹配所有部署相关工作流）
          # delete_workflow_pattern: 'Deploy*'
          # 可选：按状态删除（如 'completed' 仅删除已完成的）
          # delete_workflow_by_state_pattern: 'completed'
          # 可选：按结论删除（如 'failure' 仅删除失败的运行）
          # delete_run_by_conclusion_pattern: 'failure'
          # 测试模式：设为true时仅显示要删除的记录，不实际删除
          dry_run: false
