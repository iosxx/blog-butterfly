name: Workflow Run Cleaner

on:
  # æ¯å‘¨ä¸€åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹è‡ªåŠ¨æ¸…ç†ï¼ˆä¿ç•™7å¤©è®°å½•ï¼‰
  schedule:
    - cron: '0 0 * * 1'  # UTCæ—¶é—´æ¯å‘¨ä¸€00:00 (åŒ—äº¬æ—¶é—´å‘¨ä¸€08:00)
  
  # æ‰‹åŠ¨è§¦å‘é€‰é¡¹ï¼ˆåœ¨Actionsç•Œé¢æ¸…æ™°å¯è§ï¼‰
  workflow_dispatch:
    inputs:
      full_cleanup:
        description: "æ‰§è¡Œå…¨éƒ¨æ¸…ç†ï¼Ÿ"
        type: boolean
        required: false
        default: false

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      # ç¡®å®šæ¸…ç†æ¨¡å¼
      - name: Determine cleanup mode
        id: mode
        run: |
          if ${{ inputs.full_cleanup || 'false' }}; then
            echo "mode=full" >> $GITHUB_OUTPUT
            echo "::warning::ğŸš¨ å…¨é‡æ¸…ç†æ¨¡å¼æ¿€æ´»! å°†åˆ é™¤æ‰€æœ‰å¯æ¸…ç†çš„å·¥ä½œæµå†å²"
          else
            echo "mode=weekly" >> $GITHUB_OUTPUT
            echo "::notice::â„¹ï¸ æ‰§è¡Œå‘¨åº¦æ¸…ç† (ä¿ç•™7å¤©è®°å½•)"
          fi
      
      # å‘¨åº¦æ¸…ç†æ¨¡å¼ (é»˜è®¤)
      - name: Weekly cleanup (7 days)
        if: steps.mode.outputs.mode == 'weekly'
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 7
          keep_minimum_runs: 10
          exclude_workflows: "Workflow Run Cleaner"
          exclude_status: "in_progress,queued"
          debug: true
      
      # å…¨é‡æ¸…ç†æ¨¡å¼ (æ‰‹åŠ¨è§¦å‘)
      - name: Full cleanup (DELETE ALL)
        if: steps.mode.outputs.mode == 'full'
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 0
          exclude_status: "in_progress,queued"
          exclude_workflows: "Workflow Run Cleaner"
          debug: true
      
      # å®Œæˆé€šçŸ¥
      - name: Completion notice
        run: |
          if [ "${{ steps.mode.outputs.mode }}" == "full" ]; then
            echo "::warning::âœ… å…¨é‡æ¸…ç†å®Œæˆ! å·²åˆ é™¤æ‰€æœ‰å¯æ¸…ç†çš„å·¥ä½œæµå†å²"
          else
            echo "::notice::âœ… å‘¨åº¦æ¸…ç†å®Œæˆ! ä¿ç•™7å¤©å†…çš„è¿è¡Œè®°å½•"
          fi
